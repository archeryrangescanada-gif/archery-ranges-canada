// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL") // Ensure this is set in your .env file
}

model Subscriber {
  id            String       @id @default(cuid())
  email         String       @unique
  firstName     String?
  lastName      String?
  status        SubscriberStatus @default(ACTIVE)
  metadata      Json?        // Stores tags like ["newsletter", "customer"] or { "source": "landing_page" }
  subscribedAt  DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  // Relations
  events        EmailEvent[]

  @@index([email])
}

model Campaign {
  id            String       @id @default(cuid())
  name          String       // Internal name for your reference
  subject       String
  preheader     String?
  bodyHtml      String       @db.Text // @db.Text allows for large HTML strings
  status        CampaignStatus @default(DRAFT)
  scheduledFor  DateTime?
  sentAt        DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  // Relations
  events        EmailEvent[]
}

model EmailEvent {
  id            String       @id @default(cuid())
  type          EventType
  createdAt     DateTime     @default(now())

  // Relations
  campaignId    String
  campaign      Campaign     @relation(fields: [campaignId], references: [id])
  
  subscriberId  String?      // Optional: keep even if subscriber is deleted
  subscriber    Subscriber?  @relation(fields: [subscriberId], references: [id])

  @@index([campaignId])
  @@index([type])
}

// --- Enums ---

enum SubscriberStatus {
  ACTIVE
  UNSUBSCRIBED
  BOUNCED
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  FAILED
}

enum EventType {
  OPEN
  CLICK
  BOUNCE
  SPAM_COMPLAINT
  UNSUBSCRIBE
}